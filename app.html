<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¢å…±æœ‰ã‚¢ãƒ—ãƒª - ãƒ¡ãƒ¢ç®¡ç†</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- PWAå¯¾å¿œ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="memo.">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- Markdown to HTMLå¤‰æ›ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="app-header">
            <h1>ğŸ“ ãƒ¡ãƒ¢ç®¡ç†</h1>
            <div class="header-info">
                <div class="user-info">
                    <span class="user-info-label">ãƒ­ã‚°ã‚¤ãƒ³ID (ãƒ‘ã‚¹ã‚­ãƒ¼):</span>
                    <span id="displayPasscode" class="user-passcode"></span>
                </div>
                <div class="header-actions">
                    <button id="viewLogsBtn" class="btn btn-secondary">ğŸ“Š ãƒ­ã‚°ç¢ºèª</button>
                    <button id="changePasscodeBtn" class="btn btn-secondary">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´</button>
                    <button id="deleteAccountBtn" class="btn btn-danger">ğŸ—‘ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button>
                    <button id="logoutBtn" class="btn btn-secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼: ãƒ¡ãƒ¢ä¸€è¦§ -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>ãƒ¡ãƒ¢ä¸€è¦§</h2>
                    <button id="newNoteBtn" class="btn btn-primary">+ æ–°è¦ä½œæˆ</button>
                </div>
                
                <div class="note-list" id="noteList">
                    <!-- ãƒ¡ãƒ¢ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </aside>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢: ãƒ¡ãƒ¢ç·¨é›† -->
            <main class="note-editor">
                <div id="noNoteSelected" class="no-note-selected">
                    <p>ãƒ¡ãƒ¢ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°è¦ä½œæˆã—ã¦ãã ã•ã„</p>
                </div>

                <div id="noteEditorContent" class="note-editor-content" style="display: none;">
                    <div class="note-header">
                        <input 
                            type="text" 
                            id="noteTitle" 
                            placeholder="ãƒ¡ãƒ¢ã®ã‚¿ã‚¤ãƒˆãƒ«" 
                            class="note-title-input"
                            readonly
                        >
                        <div class="note-actions">
                            <button id="editBtn" class="btn btn-primary">ç·¨é›†</button>
                            <button id="saveBtn" class="btn btn-success" style="display: none;">ä¿å­˜</button>
                            <button id="cancelBtn" class="btn btn-secondary" style="display: none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button id="deleteBtn" class="btn btn-danger">å‰Šé™¤</button>
                        </div>
                    </div>

                    <div class="note-content">
                        <!-- é–²è¦§ãƒ¢ãƒ¼ãƒ‰ -->
                        <div id="noteView" class="note-view">
                            <!-- Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                        
                        <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
                        <textarea 
                            id="noteContent" 
                            class="note-textarea" 
                            placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆMarkdownå½¢å¼å¯¾å¿œï¼‰"
                            style="display: none;"
                        ></textarea>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="changePasscodeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´</h2>
            <form id="changePasscodeForm">
                <div class="form-group">
                    <label for="newPasscode">æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ (12æ¡)</label>
                    <input 
                        type="text" 
                        id="newPasscode" 
                        maxlength="12" 
                        pattern="[0-9A-Z]{12}" 
                        placeholder="ä¾‹: 123ABC789XYZ"
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="confirmPasscode">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ç¢ºèª</label>
                    <input 
                        type="text" 
                        id="confirmPasscode" 
                        maxlength="12" 
                        pattern="[0-9A-Z]{12}" 
                        placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„"
                        required
                    >
                </div>
                <div id="passcodeMessage" class="message"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">å¤‰æ›´</button>
                    <button type="button" id="cancelPasscodeBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <script src="supabase-client.js"></script>
    <script src="app.js"></script>
    <script>
        /**
         * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
         * æ©Ÿèƒ½: ãƒ¡ãƒ¢ã®è¡¨ç¤ºã€ç·¨é›†ã€ä¿å­˜ã€å‰Šé™¤ãªã©ã®ç®¡ç†
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¢ã‚’ç°¡å˜ã«ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentNoteId = null; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ã®ID
        let isEditMode = false; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹
        let originalContent = ''; // ç·¨é›†å‰ã®å†…å®¹ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ï¼‰
        let originalTitle = ''; // ç·¨é›†å‰ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ï¼‰
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆlocalStorageã‹ã‚‰å–å¾—ã—ã¦è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³å¯¾å¿œï¼‰
            const userId = localStorage.getItem('userId');
            if (!userId) {
                window.location.href = 'index.html';
                return;
            }
            
            // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            const passcode = localStorage.getItem('passcode');
            if (passcode) {
                document.getElementById('displayPasscode').textContent = passcode;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            await loadNotes();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners();
        });
        
        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
         * æ©Ÿèƒ½: ãƒœã‚¿ãƒ³ã‚„ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«å¿œç­”ã™ã‚‹ãŸã‚
         */
        function setupEventListeners() {
            document.getElementById('newNoteBtn').addEventListener('click', createNewNote);
            document.getElementById('deleteAccountBtn').addEventListener('click', deleteAccountConfirm);
            document.getElementById('editBtn').addEventListener('click', enterEditMode);
            document.getElementById('saveBtn').addEventListener('click', saveNote);
            document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
            document.getElementById('deleteBtn').addEventListener('click', deleteNote);
            document.getElementById('viewLogsBtn').addEventListener('click', viewLogs);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('changePasscodeBtn').addEventListener('click', showChangePasscodeModal);
            document.getElementById('cancelPasscodeBtn').addEventListener('click', hideChangePasscodeModal);
            document.getElementById('changePasscodeForm').addEventListener('submit', changePasscode);
        }
        
        /**
         * ãƒ¡ãƒ¢ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
         * æ©Ÿèƒ½: Supabaseã‹ã‚‰ãƒ¡ãƒ¢ã‚’å–å¾—ã—ã¦è¡¨ç¤º
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¢ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚
         */
        async function loadNotes() {
            const userId = localStorage.getItem('userId');
            const notes = await getNotes(userId);
            
            const noteList = document.getElementById('noteList');
            noteList.innerHTML = '';
            
            if (notes.length === 0) {
                noteList.innerHTML = '<p class="empty-message">ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            notes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';
                if (note.id === currentNoteId) {
                    noteItem.classList.add('active');
                }
                
                noteItem.innerHTML = `
                    <div class="note-item-title">${escapeHtml(note.title)}</div>
                    <div class="note-item-date">${formatDate(note.updated_at)}</div>
                `;
                
                noteItem.addEventListener('click', () => selectNote(note));
                noteList.appendChild(noteItem);
            });
        }
        
        /**
         * ãƒ¡ãƒ¢ã‚’é¸æŠã—ã¦è¡¨ç¤º
         * æ©Ÿèƒ½: é¸æŠã•ã‚ŒãŸãƒ¡ãƒ¢ã®å†…å®¹ã‚’è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è¡¨ç¤º
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¢ã®å†…å®¹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        async function selectNote(note) {
            if (isEditMode) {
                if (!confirm('ç·¨é›†ä¸­ã®å†…å®¹ãŒå¤±ã‚ã‚Œã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    return;
                }
                exitEditMode();
            }
            
            currentNoteId = note.id;
            
            // UIã®è¡¨ç¤º
            document.getElementById('noNoteSelected').style.display = 'none';
            document.getElementById('noteEditorContent').style.display = 'block';
            
            // ãƒ¡ãƒ¢ã®å†…å®¹ã‚’è¡¨ç¤º
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content || '';
            
            // Markdownã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const noteView = document.getElementById('noteView');
            noteView.innerHTML = marked.parse(note.content || '');
            noteView.style.display = 'block';
            
            // ãƒ¡ãƒ¢ä¸€è¦§ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            await loadNotes();
            
            // ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’è¨˜éŒ²
            const userId = localStorage.getItem('userId');
            await logAccess(userId, note.id, 'é–²è¦§');
        }
        
        /**
         * æ–°è¦ãƒ¡ãƒ¢ã‚’ä½œæˆ
         * æ©Ÿèƒ½: ç©ºã®ãƒ¡ãƒ¢ã‚’ä½œæˆã—ã¦ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ã—ã„ãƒ¡ãƒ¢ã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        async function createNewNote() {
            if (isEditMode) {
                if (!confirm('ç·¨é›†ä¸­ã®å†…å®¹ãŒå¤±ã‚ã‚Œã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    return;
                }
                exitEditMode();
            }
            
            const userId = localStorage.getItem('userId');
            const title = `æ–°ã—ã„ãƒ¡ãƒ¢ ${new Date().toLocaleString('ja-JP')}`;
            
            // æ–°è¦ãƒ¡ãƒ¢ã‚’ä½œæˆ
            const newNote = await createNote(userId, title, '');
            
            if (newNote) {
                currentNoteId = newNote.id;
                await loadNotes();
                await selectNote(newNote);
                enterEditMode();
            }
        }
        
        /**
         * ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
         * æ©Ÿèƒ½: ãƒ¡ãƒ¢ã‚’ç·¨é›†å¯èƒ½ãªçŠ¶æ…‹ã«ã™ã‚‹
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¢ã®å†…å®¹ã‚’ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        function enterEditMode() {
            isEditMode = true;
            
            // å…ƒã®å†…å®¹ã‚’ä¿å­˜ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ï¼‰
            originalTitle = document.getElementById('noteTitle').value;
            originalContent = document.getElementById('noteContent').value;
            
            // UIåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('noteTitle').readOnly = false;
            document.getElementById('noteView').style.display = 'none';
            document.getElementById('noteContent').style.display = 'block';
            
            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            document.getElementById('deleteBtn').style.display = 'none';
        }
        
        /**
         * ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
         * æ©Ÿèƒ½: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹
         * ä½œæˆç†ç”±: ç·¨é›†å®Œäº†å¾Œã«é€šå¸¸è¡¨ç¤ºã«æˆ»ã™ãŸã‚
         */
        function exitEditMode() {
            isEditMode = false;
            
            // UIåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('noteTitle').readOnly = true;
            document.getElementById('noteView').style.display = 'block';
            document.getElementById('noteContent').style.display = 'none';
            
            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'inline-block';
        }
        
        /**
         * ãƒ¡ãƒ¢ã‚’ä¿å­˜
         * æ©Ÿèƒ½: ç·¨é›†ã—ãŸãƒ¡ãƒ¢ã‚’Supabaseã«ä¿å­˜
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†å†…å®¹ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ãŸã‚
         */
        async function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value;
            
            if (!title) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ¡ãƒ¢ã‚’æ›´æ–°
            const updated = await updateNote(currentNoteId, title, content);
            
            if (updated) {
                // Markdownã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                const noteView = document.getElementById('noteView');
                noteView.innerHTML = marked.parse(content || '');
                
                exitEditMode();
                await loadNotes();
                
                // ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’è¨˜éŒ²
                const userId = localStorage.getItem('userId');
                await logAccess(userId, currentNoteId, 'ç·¨é›†');
            }
        }
        
        /**
         * ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
         * æ©Ÿèƒ½: ç·¨é›†å†…å®¹ã‚’ç ´æ£„ã—ã¦å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†ã‚’ã‚„ã‚Šç›´ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        function cancelEdit() {
            if (confirm('ç·¨é›†å†…å®¹ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ')) {
                // å…ƒã®å†…å®¹ã«æˆ»ã™
                document.getElementById('noteTitle').value = originalTitle;
                document.getElementById('noteContent').value = originalContent;
                
                exitEditMode();
            }
        }
        
        /**
         * ãƒ¡ãƒ¢ã‚’å‰Šé™¤
         * æ©Ÿèƒ½: é¸æŠä¸­ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤
         * ä½œæˆç†ç”±: ä¸è¦ãªãƒ¡ãƒ¢ã‚’å‰Šé™¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        async function deleteNote() {
            if (confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const deleted = await deleteNoteById(currentNoteId);
                
                if (deleted) {
                    currentNoteId = null;
                    document.getElementById('noNoteSelected').style.display = 'block';
                    document.getElementById('noteEditorContent').style.display = 'none';
                    
                    await loadNotes();
                }
            }
        }

        /**
         * ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãï¼‰
         * æ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã™ã¹ã¦ã®é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        async function deleteAccountConfirm() {
            const userId = localStorage.getItem('userId');
            
            // ä¸‰é‡ç¢ºèª
            if (!confirm('âš ï¸ é‡è¦ãªè­¦å‘Š\n\nã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nä»¥ä¸‹ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ï¼š\nãƒ»ã™ã¹ã¦ã®ãƒ¡ãƒ¢\nãƒ»ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°\nãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚')) {
                return;
            }
            
            if (!confirm('æœ€çµ‚ç¢ºèªã§ã™ã€‚æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            // å‰Šé™¤å®Ÿè¡Œ
            const result = await deleteUserAccount(userId);
            
            if (result.success) {
                alert(result.message + '\n\nãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚');
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                localStorage.clear();
                window.location.href = 'index.html';
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            }
        }
        
        /**
         * ãƒ­ã‚°ç¢ºèªãƒšãƒ¼ã‚¸ã¸ç§»å‹•
         * æ©Ÿèƒ½: ãƒ­ã‚°ç¢ºèªãƒšãƒ¼ã‚¸ã‚’é–‹ã
         * ä½œæˆç†ç”±: è©³ç´°ãªãƒ­ã‚°æƒ…å ±ã‚’åˆ¥ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        function viewLogs() {
            window.location.href = 'logs.html';
        }
        
        /**
         * ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
         * æ©Ÿèƒ½: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }
        
        /**
         * ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
         * æ©Ÿèƒ½: ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ç”¨ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        function showChangePasscodeModal() {
            document.getElementById('changePasscodeModal').style.display = 'flex';
            document.getElementById('newPasscode').value = '';
            document.getElementById('confirmPasscode').value = '';
            document.getElementById('passcodeMessage').textContent = '';
        }
        
        /**
         * ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
         * æ©Ÿèƒ½: ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        function hideChangePasscodeModal() {
            document.getElementById('changePasscodeModal').style.display = 'none';
        }
        
        /**
         * ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´
         * æ©Ÿèƒ½: æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’Supabaseã«ä¿å­˜
         * ä½œæˆç†ç”±: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¶­æŒã®ãŸã‚ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚
         */
        async function changePasscode(e) {
            e.preventDefault();
            
            const newPasscode = document.getElementById('newPasscode').value;
            const confirmPasscode = document.getElementById('confirmPasscode').value;
            const messageDiv = document.getElementById('passcodeMessage');
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (newPasscode.length !== 12 || !/^[0-9A-Z]{12}$/i.test(newPasscode)) {
                messageDiv.textContent = 'ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯12æ¡ã®è‹±æ•°å­—(0-9, A-Z)ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                messageDiv.className = 'message error';
                return;
            }
            
            if (newPasscode !== confirmPasscode) {
                messageDiv.textContent = 'ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“';
                messageDiv.className = 'message error';
                return;
            }
            
            // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†
            const userId = localStorage.getItem('userId');
            const result = await updatePasscode(userId, newPasscode);
            
            if (result.success) {
                messageDiv.textContent = 'ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ';
                messageDiv.className = 'message success';
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
                localStorage.setItem('passcode', newPasscode);
                
                setTimeout(() => {
                    hideChangePasscodeModal();
                }, 1500);
            } else {
                messageDiv.textContent = result.message || 'ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ';
                messageDiv.className = 'message error';
            }
        }
        
        /**
         * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
         * æ©Ÿèƒ½: XSSæ”»æ’ƒã‚’é˜²ããŸã‚HTMLã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
         * ä½œæˆç†ç”±: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®ãŸã‚
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         * æ©Ÿèƒ½: ISOæ—¥ä»˜ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ›
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„æ—¥æ™‚è¡¨ç¤ºã‚’æä¾›ã™ã‚‹ãŸã‚
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
