<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¢å…±æœ‰ã‚¢ãƒ—ãƒª - ãƒ­ã‚°ç¢ºèª</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="app-header">
            <h1>ğŸ“Š ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°</h1>
            <div class="header-info">
                <div class="user-info">
                    <span class="user-info-label">ãƒ­ã‚°ã‚¤ãƒ³ID (ãƒ‘ã‚¹ã‚­ãƒ¼):</span>
                    <span id="displayPasscode" class="user-passcode"></span>
                </div>
                <div class="header-actions">
                    <button id="backBtn" class="btn btn-secondary">â† ãƒ¡ãƒ¢ç®¡ç†ã«æˆ»ã‚‹</button>
                    <button id="logoutBtn" class="btn btn-secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="logs-container">
            <div class="logs-header">
                <div>
                    <p style="color: var(--text-secondary); margin-top: var(--spacing-xs);">
                        ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™
                    </p>
                </div>
                <div class="logs-actions">
                    <button id="refreshBtn" class="btn btn-primary">ğŸ”„ æ›´æ–°</button>
                    <button id="deleteOldLogsBtn" class="btn btn-danger">ğŸ—‘ï¸ å¤ã„ãƒ­ã‚°å‰Šé™¤ (14æ—¥ä»¥å‰)</button>
                </div>
            </div>

            <div class="logs-list" id="logsList">
                <!-- ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script src="supabase-client.js"></script>
    <script src="app.js"></script>
    <script>
        /**
         * ãƒ­ã‚°ãƒšãƒ¼ã‚¸ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
         * æ©Ÿèƒ½: ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®è©³ç´°è¡¨ç¤ºã¨ç®¡ç†
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©³ç´°ãªãƒ­ã‚°æƒ…å ±ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
            const userId = sessionStorage.getItem('userId');
            if (!userId) {
                window.location.href = 'index.html';
                return;
            }
            
            // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            const passcode = sessionStorage.getItem('passcode');
            if (passcode) {
                document.getElementById('displayPasscode').textContent = passcode;
            }
            
            // ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
            await loadAllLogs();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners();
        });
        
        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
         * æ©Ÿèƒ½: ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«å¿œç­”ã™ã‚‹ãŸã‚
         */
        function setupEventListeners() {
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'app.html';
            });
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('refreshBtn').addEventListener('click', loadAllLogs);
            document.getElementById('deleteOldLogsBtn').addEventListener('click', deleteOldLogsConfirm);
        }
        
        /**
         * ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€
         * æ©Ÿèƒ½: Supabaseã‹ã‚‰ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’å–å¾—ã—ã¦è¡¨ç¤º
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ´»å‹•å±¥æ­´ã‚’è©³ç´°ã«è¡¨ç¤ºã™ã‚‹ãŸã‚
         */
        async function loadAllLogs() {
            const userId = sessionStorage.getItem('userId');
            const logs = await getAccessLog(userId);
            
            const logsList = document.getElementById('logsList');
            logsList.innerHTML = '';
            
            if (logs.length === 0) {
                logsList.innerHTML = '<p class="empty-message" style="text-align: center; padding: var(--spacing-xl);">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                logItem.innerHTML = `
                    <div class="log-header">
                        <span class="log-action">${escapeHtml(log.action)}</span>
                        <span class="log-note">ãƒ¡ãƒ¢: ${escapeHtml(log.note_title || 'å‰Šé™¤æ¸ˆã¿')}</span>
                        <span class="log-date">${formatDate(log.created_at)}</span>
                    </div>
                    <div class="log-details">
                        <div class="log-detail-item">
                            <span>ğŸŒ <strong>ãƒ–ãƒ©ã‚¦ã‚¶:</strong></span>
                            <span>${escapeHtml(log.browser || 'Unknown')}</span>
                        </div>
                        <div class="log-detail-item">
                            <span>ğŸ’» <strong>OS:</strong></span>
                            <span>${escapeHtml(log.os || 'Unknown')}</span>
                        </div>
                        <div class="log-detail-item">
                            <span>ğŸ“± <strong>ãƒ‡ãƒã‚¤ã‚¹:</strong></span>
                            <span>${escapeHtml(log.device || 'Unknown')}</span>
                        </div>
                        <div class="log-detail-item">
                            <span>ğŸ”— <strong>IPã‚¢ãƒ‰ãƒ¬ã‚¹:</strong></span>
                            <span>${escapeHtml(log.ip_address || 'Unknown')}</span>
                        </div>
                        <div class="log-detail-item" style="grid-column: 1 / -1;">
                            <span>ğŸ” <strong>User Agent:</strong></span>
                            <span style="word-break: break-all; font-size: 0.75rem;">${escapeHtml(log.user_agent || 'Unknown')}</span>
                        </div>
                    </div>
                `;
                logsList.appendChild(logItem);
            });
        }
        
        /**
         * å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãï¼‰
         * æ©Ÿèƒ½: 14æ—¥ã‚ˆã‚Šå‰ã®ãƒ­ã‚°ã‚’å‰Šé™¤
         * ä½œæˆç†ç”±: ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®è‚¥å¤§åŒ–ã‚’é˜²ããŸã‚
         */
        async function deleteOldLogsConfirm() {
            if (!confirm('âš ï¸ ç¢ºèª\n\n14æ—¥ã‚ˆã‚Šå‰ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            const userId = sessionStorage.getItem('userId');
            const result = await deleteOldLogs(userId);
            
            if (result.success) {
                alert(result.message);
                await loadAllLogs();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            }
        }
        
        /**
         * ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
         * æ©Ÿèƒ½: ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
         */
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }
        
        /**
         * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
         * æ©Ÿèƒ½: XSSæ”»æ’ƒã‚’é˜²ããŸã‚HTMLã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
         * ä½œæˆç†ç”±: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®ãŸã‚
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         * æ©Ÿèƒ½: ISOæ—¥ä»˜ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ›
         * ä½œæˆç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„æ—¥æ™‚è¡¨ç¤ºã‚’æä¾›ã™ã‚‹ãŸã‚
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
    </script>
</body>
</html>
